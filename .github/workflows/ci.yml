name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

# Explicit permissions for security
permissions:
    contents: read

env:
    RUST_BACKTRACE: 1
    CARGO_TERM_COLOR: always

jobs:
    test:
        name: Test
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                rust: [stable, beta]
                exclude:
                    # Only run beta on Ubuntu to save CI time
                    - os: windows-latest
                      rust: beta
                    - os: macos-latest
                      rust: beta
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust ${{ matrix.rust }}
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.rust }}

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: ${{ matrix.os }}-${{ matrix.rust }}

            - name: Build
              run: cargo build --workspace --verbose

            - name: Run tests
              run: cargo test --workspace --verbose

            - name: Run doc tests
              run: cargo test --workspace --doc --verbose

    fmt:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt

            - name: Check formatting
              run: cargo fmt --all --check

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Run clippy
              run: cargo clippy --workspace --all-targets --all-features -- -D warnings

    docs:
        name: Documentation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Check documentation
              run: cargo doc --workspace --no-deps --all-features
              env:
                  RUSTDOCFLAGS: -D warnings

    msrv:
        name: MSRV (Minimum Supported Rust Version)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust 1.88
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: "1.88"

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: msrv-1.88

            - name: Check MSRV
              run: cargo build --workspace --verbose

    coverage-unit:
        name: Coverage (Unit Tests)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: llvm-tools-preview

            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: coverage-unit

            - name: Run unit test coverage
              run: |
                  echo "::group::Unit coverage"
                  mkdir -p coverage
                  cargo llvm-cov --workspace --all-features --lcov --output-path coverage/lcov.info --summary-only | tee coverage/summary.txt
                  echo "::endgroup::"

            - name: Coverage summary
              run: |
                  echo "### Coverage (Unit Tests)" >> "$GITHUB_STEP_SUMMARY"
                  sed -n '1,3p' coverage/summary.txt >> "$GITHUB_STEP_SUMMARY"

            - name: Upload coverage artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: unit-coverage
                  path: coverage/

    integration:
        name: Integration Tests (Real Org)
        runs-on: ubuntu-latest
        environment: scratch
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: llvm-tools-preview

            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: integration-tests

            - name: Require SF_AUTH_URL
              env:
                  SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
              run: |
                  if [ -z "$SF_AUTH_URL" ]; then
                    echo "ERROR: SF_AUTH_URL secret is not set"
                    exit 1
                  fi
                  echo "âœ“ SF_AUTH_URL secret is available"

            - name: Integration tests (with coverage)
              env:
                  SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
              run: |
                  echo "::group::Integration tests"
                  mkdir -p coverage
                cargo llvm-cov --workspace --all-features --test integration --lcov --output-path coverage/lcov.info --summary-only -- --nocapture | tee coverage/summary.txt
                  echo "::endgroup::"

            - name: Integration tests summary
              if: always()
              run: |
                  echo "### Integration Tests (Real Org)" >> "$GITHUB_STEP_SUMMARY"
                  echo "- SF_AUTH_URL available: true" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Job status: ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
                  if [ -f coverage/summary.txt ]; then
                    echo "" >> "$GITHUB_STEP_SUMMARY"
                    sed -n '1,3p' coverage/summary.txt >> "$GITHUB_STEP_SUMMARY"
                  fi

            - name: Coverage summary
              run: |
                  if [ -f coverage/summary.txt ]; then
                    cat coverage/summary.txt >> "$GITHUB_STEP_SUMMARY"
                  else
                    echo "No coverage summary generated" >> "$GITHUB_STEP_SUMMARY"
                  fi

            - name: Upload coverage artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: integration-coverage
                  path: coverage/
