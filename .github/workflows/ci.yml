name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

# Explicit permissions for security
permissions:
    contents: read

env:
    RUST_BACKTRACE: 1
    CARGO_TERM_COLOR: always

jobs:
    test:
        name: Test
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                rust: [stable, beta]
                exclude:
                    # Only run beta on Ubuntu to save CI time
                    - os: windows-latest
                      rust: beta
                    - os: macos-latest
                      rust: beta
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust ${{ matrix.rust }}
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.rust }}

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: ${{ matrix.os }}-${{ matrix.rust }}

            - name: Build
              run: cargo build --workspace --verbose

            - name: Run unit tests
              run: cargo test --workspace --lib --verbose

            - name: Run doc tests
              run: cargo test --workspace --doc --verbose

    fmt:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt

            - name: Check formatting
              run: cargo fmt --all --check

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Run clippy
              run: cargo clippy --workspace --all-targets --all-features -- -D warnings

    docs:
        name: Documentation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Check documentation
              run: cargo doc --workspace --no-deps --all-features
              env:
                  RUSTDOCFLAGS: -D warnings

    msrv:
        name: MSRV (Minimum Supported Rust Version)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust 1.88
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: "1.88"

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: msrv-1.88

            - name: Check MSRV
              run: cargo build --workspace --verbose

    coverage-unit:
        name: Coverage (Unit Tests)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: llvm-tools-preview

            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: coverage-unit

            - name: Run unit test coverage
              run: |
                  echo "::group::Unit coverage"
                  mkdir -p coverage
                  # Run tests and capture output
                  set +e
                  cargo test --workspace --lib --all-features --verbose 2>&1 | tee coverage/test-output.txt
                  TEST_EXIT_CODE=$?
                  set -e
                  
                  # Extract test summary
                  echo "Test exit code: $TEST_EXIT_CODE" > coverage/test-summary.txt
                  grep "test result:" coverage/test-output.txt >> coverage/test-summary.txt || true
                  
                  # Run coverage
                  cargo llvm-cov --workspace --all-features --lib --lcov --output-path coverage/lcov-unit.info --summary-only | tee coverage/summary.txt
                  echo "::endgroup::"
                  
                  exit $TEST_EXIT_CODE

            - name: Coverage summary
              if: always()
              run: |
                  echo "## Unit Test Coverage" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  
                  # Test results
                  if [ -f coverage/test-summary.txt ]; then
                    echo "### Test Results" >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                    cat coverage/test-summary.txt >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                    echo "" >> "$GITHUB_STEP_SUMMARY"
                  fi
                  
                  # Coverage details
                  if [ -f coverage/summary.txt ]; then
                    echo "### Coverage Details" >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                    cat coverage/summary.txt >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                  fi

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  files: ./coverage/lcov-unit.info
                  flags: unit-tests
                  name: unit-tests
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

            - name: Upload coverage artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: unit-coverage
                  path: coverage/

    integration:
        name: Integration Tests (Real Org)
        runs-on: ubuntu-latest
        environment: scratch
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: llvm-tools-preview

            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: integration-tests

            - name: Require SF_AUTH_URL
              env:
                  SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
              run: |
                  if [ -z "$SF_AUTH_URL" ]; then
                    echo "ERROR: SF_AUTH_URL secret is not set"
                    exit 1
                  fi
                  echo "âœ“ SF_AUTH_URL secret is available"

            - name: Integration tests (with coverage)
              env:
                  SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
              run: |
                  echo "::group::Integration tests"
                  mkdir -p coverage
                  # Run tests and capture output for summary
                  set +e
                  cargo test --workspace --test integration --all-features -- --nocapture 2>&1 | tee coverage/test-output.txt
                  TEST_EXIT_CODE=$?
                  set -e
                  
                  # Extract test summary
                  echo "Test exit code: $TEST_EXIT_CODE" > coverage/test-summary.txt
                  grep "test result:" coverage/test-output.txt >> coverage/test-summary.txt || true
                  
                  # Run with coverage for reporting
                  cargo llvm-cov --workspace --all-features --test integration --lcov --output-path coverage/lcov-integration.info --summary-only -- --nocapture | tee coverage/summary.txt
                  echo "::endgroup::"
                  
                  # Exit with original test exit code
                  exit $TEST_EXIT_CODE

            - name: Integration tests summary
              if: always()
              run: |
                  echo "## Integration Tests (Real Org)" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  
                  # Test results
                  if [ -f coverage/test-summary.txt ]; then
                    echo "### Test Results" >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                    cat coverage/test-summary.txt >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                    echo "" >> "$GITHUB_STEP_SUMMARY"
                  fi
                  
                  # Show failed tests if any
                  if [ -f coverage/test-output.txt ]; then
                    if grep -q "FAILED" coverage/test-output.txt; then
                      echo "### Failed Tests" >> "$GITHUB_STEP_SUMMARY"
                      echo '```' >> "$GITHUB_STEP_SUMMARY"
                      grep "test.*FAILED" coverage/test-output.txt | head -20 >> "$GITHUB_STEP_SUMMARY"
                      echo '```' >> "$GITHUB_STEP_SUMMARY"
                      echo "" >> "$GITHUB_STEP_SUMMARY"
                      
                      # Show error details
                      echo "### Error Details" >> "$GITHUB_STEP_SUMMARY"
                      echo '```' >> "$GITHUB_STEP_SUMMARY"
                      grep -A 10 "failures:" coverage/test-output.txt | head -30 >> "$GITHUB_STEP_SUMMARY"
                      echo '```' >> "$GITHUB_STEP_SUMMARY"
                      echo "" >> "$GITHUB_STEP_SUMMARY"
                    fi
                  fi
                  
                  # Coverage summary
                  if [ -f coverage/summary.txt ]; then
                    echo "### Coverage" >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                    cat coverage/summary.txt >> "$GITHUB_STEP_SUMMARY"
                    echo '```' >> "$GITHUB_STEP_SUMMARY"
                  fi

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  files: ./coverage/lcov-integration.info
                  flags: integration-tests
                  name: integration-tests
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

            - name: Upload coverage artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: integration-coverage
                  path: coverage/
